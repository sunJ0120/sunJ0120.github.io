---
title: "ğŸ± Redisë¥¼ ë„ì…í•´ì„œ ìºì‹± ì‘ì—…ì„ ì§„í–‰í•´ë³´ì!!! [3íƒ„]"
layout: post
categories: [redis]
tags: [redis, NoSQL]
toc: true
toc_sticky: true
toc_label: ëª©ì°¨
author_profile: true
permalink: /redis/3
---

# ğŸ–¤ Intro

ì˜¤ëŠ˜ ì•Œì•„ë³¼ ê²ƒì€, ìš°ë¦¬ê°€ êµ¬ì„±í•œ Redisë¥¼ ì´ìš©í•œ Service ì½”ë“œë¥¼ ì–´ë–»ê²Œ í™œìš©í•´ì•¼ í• ì§€ë¥¼ test codeë¡œ ì•Œì•„ë³´ê³ ì í•œë‹¤

ê·¸ì™€ í•¨ê»˜, test codeê°€ ì•„ë‹Œ í™˜ê²½ì—ì„œ ê°œë°œí• ë•Œ ìš°ë¦¬ê°€ ì´ êµ¬ì¡°ë¥¼ ì–´ë–»ê²Œ í™œìš©í•´ì„œ ì„œë¹„ìŠ¤ë¥¼ êµ¬ì„±í•  ìˆ˜ ìˆì„ì§€ë¥¼ ë¯¸ë¦¬ ì‚´í´ë³´ì.

# ğŸ©¶ Start

```java
/*
í˜„ì¬ ìš°ë¦¬ëŠ” docker container ìœ„ì— redisê°€ ìˆìœ¼ë¯€ë¡œ, dockerë¥¼ ìë™ìœ¼ë¡œ ì‹¤í–‰í•´ì„œ testë¥¼ ì§„í–‰í•˜ë„ë¡ í•˜ì.
ìºì‹± ê¸°ëŠ¥ & ìºì‹œ íˆíŠ¸ ë° ë¯¸ìŠ¤ê°€ ì •ìƒì ìœ¼ë¡œ ë™ì‘í•˜ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.
*/
@Testcontainers
@SpringBootTest
@Slf4j
class MemberServiceCacheTest {

    private static final String REDIS_PASSWORD = System.getenv().get("REDIS_PASSWORD");

    @Container
    static GenericContainer<?> redis = new GenericContainer<>("redis:7")
            .withExposedPorts(6379)
            .withCommand("redis-server", "--requirepass", REDIS_PASSWORD);

    @DynamicPropertySource
    static void redisProps(DynamicPropertyRegistry r) {
        r.add("spring.data.redis.host", () -> redis.getHost());
        r.add("spring.data.redis.port", () -> redis.getMappedPort(6379));
        r.add("spring.data.redis.password", () -> REDIS_PASSWORD);
    }

    @Autowired
    MemberService memberService;

    @MockitoBean
    MemberRepository memberRepository; // DB ëŒ€ì‹  ëª©

    @Autowired
    RedisTemplate<String, Object> redisTemplate; // ë‚´ê°€ ì •ì˜í•œ ì»¤ìŠ¤í…€ í…œí”Œë¦¿ ì´ìš©

    @BeforeEach
    void flush() {
        redisTemplate.getConnectionFactory().getConnection().serverCommands().flushDb();
    }

    @Test
    void redis_actually_stores_cache() {
        Long id = 1L;
        Mockito.when(memberRepository.findBalanceByMemberId(id)).thenReturn(7000);

        // Redisê°€ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸
        Set<String> keysBefore = redisTemplate.keys("*");
        log.info("Redis keys before: {}", keysBefore);

        // ì²« ë²ˆì§¸ í˜¸ì¶œ - ìºì‹œ ì €ì¥ë¨
        int balance = memberService.getBalance(id);
        assertThat(balance).isEqualTo(7000);

        // Redisì— í‚¤ê°€ ìƒê²¼ëŠ”ì§€ í™•ì¸
        Set<String> keysAfter = redisTemplate.keys("*");
        log.info("Redis keys after: {}", keysAfter);

        // ì €ì¥ëœ ê°’ë“¤ ì¶œë ¥í•´ë³´ê¸°
        for (String key : keysAfter) {
            Object value = redisTemplate.opsForValue().get(key);
            Long ttl = redisTemplate.getExpire(key);
            log.info("Key : {}, Value : {}, TTL : {} seconds",key,value,ttl);
        }

        // RepositoryëŠ” 1ë²ˆë§Œ í˜¸ì¶œë¨ (ì™œëƒë©´.. ìºì‹±ì´ ë˜ì—ˆê¸° ë•Œë¬¸ì´ë‹¤.)
        Mockito.verify(memberRepository, Mockito.times(1)).findBalanceByMemberId(id);
    }

    @Test
    void redis_stores_different_cache_types() {
        //testì— ì‚¬ìš©í•˜ê¸° ìœ„í•œ ê°ì²´ë“¤
        Long id = 1L;
        MemberCachingDto dto = MemberCachingDto.builder()
                .name("í”¼ìš©í¬")
                .creditLimit(100000)
                .build();
        int balance = 5000;
        String hobby = "ì¶•êµ¬";

        // Repository Mock ì„¤ì •
        Mockito.when(memberRepository.findBalanceByMemberId(id)).thenReturn(balance);
        Mockito.when(memberRepository.findHobbyByMemberId(id)).thenReturn(hobby);
        Mockito.when(memberRepository.findDtoByMemberId(id)).thenReturn(dto);

        System.out.println("=== ìºì‹œ ì €ì¥ ì „ ===");
        Set<String> keysBefore = redisTemplate.keys("*");
        log.info("Redis keys: {}",keysBefore);

        // ì—¬ëŸ¬ ì¢…ë¥˜ ìºì‹œ ì €ì¥
        balance = memberService.getBalance(id);
        hobby = memberService.getHobby(id);
        dto = memberService.getSnapshot(id);

        System.out.println("=== ìºì‹œ ì €ì¥ í›„ ===");
        log.info("Balance: {}, Hobby: {}, dto : {}",balance,hobby,dto);

        Set<String> keysAfter = redisTemplate.keys("*");
        log.info("Redis keys: {}",keysAfter);

        // ëª¨ë“  ì €ì¥ëœ ë°ì´í„° ì¶œë ¥
        for (String key : keysAfter) {
            Object value = redisTemplate.opsForValue().get(key);
            Long ttl = redisTemplate.getExpire(key);
            log.info("Key: {}",key);
            log.info("Value: {}",value);
            log.info("TTL: {} seconds",ttl);
            log.info("Type: {}",redisTemplate.type(key)); //int, String, dto ë‚˜ì™€ì•¼ í•œë‹¤.
        }
        assertThat(keysAfter.size()).isGreaterThanOrEqualTo(3); // balance, hobby, dto ìµœì†Œ 3ê°œ
    }

    @Test
    void redis_cache_hit_verification() {
        Long id = 1L;
        Mockito.when(memberRepository.findBalanceByMemberId(id)).thenReturn(9999);

        System.out.println("=== ì²« ë²ˆì§¸ í˜¸ì¶œ (ìºì‹œ ë¯¸ìŠ¤) ===");
        int result1 = memberService.getBalance(id);
        Set<String> keys1 = redisTemplate.keys("*");
        log.info("Result: {}",result1);
        log.info("Redis keys: {}", keys1);

        // Repository Mockì„ ë‹¤ë¥¸ ê°’ìœ¼ë¡œ ë³€ê²½ (ìºì‹œ íˆíŠ¸ë©´ ì´ ê°’ì´ ì•ˆë‚˜ì™€ì•¼ í•¨...ë°”ë€Œê¸° ì „ ê°’ì´ ì™€ì•¼ í•˜ë‹ˆê¹Œ)
        Mockito.when(memberRepository.findBalanceByMemberId(id)).thenReturn(1111);

        System.out.println("=== ë‘ ë²ˆì§¸ í˜¸ì¶œ (ìºì‹œ íˆíŠ¸) ===");
        int result2 = memberService.getBalance(id);
        Set<String> keys2 = redisTemplate.keys("*");
        log.info("Result: {}",result2);
        log.info("Redis keys: {}", keys2);

        // ìºì‹œì—ì„œ ê°€ì ¸ì˜¨ ê°’ì´ë¯€ë¡œ ì²« ë²ˆì§¸ì™€ ê°™ì•„ì•¼ í•¨ (9999)
        assertThat(result2).isEqualTo(9999);
        assertThat(result2).isNotEqualTo(1111); // Mockì˜ ìƒˆ ê°’ì´ ì•„ë‹˜

        // RepositoryëŠ” 1ë²ˆë§Œ í˜¸ì¶œë¨ (ìºì‹œ íˆíŠ¸)
        Mockito.verify(memberRepository, Mockito.times(1)).findBalanceByMemberId(id);

        log.info("ìºì‹œ íˆíŠ¸ ì„±ê³µ! RepositoryëŠ” {}ì´ê³ , {}ë²ˆë§Œ í˜¸ì¶œ",result2,Mockito.mockingDetails(memberRepository).getInvocations().size());
    }
}
```

ì „ì²´ test codeëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤. ì—¬ê¸°ì„œ ì´ì œ ê°ê°ì˜ í…ŒìŠ¤íŠ¸ methodê°€ ë¬´ì—‡ì„ ì˜ë¯¸í•˜ëŠ”ì§€, ê° ì„¤ì •ì€ ë¬´ì—‡ì„ ì˜ë¯¸í•˜ê³  ì™œ ë‹¬ì•„ë’€ëŠ”ì§€ë¥¼ ìƒì„¸íˆ ì•Œì•„ë³´ê³ ì í•œë‹¤.

## Test code 0_ë ˆë””ìŠ¤ í…ŒìŠ¤íŠ¸ í™˜ê²½ ì„¤ì •

```java
private static final String REDIS_PASSWORD = System.getenv().get("REDIS_PASSWORD");

@Container
static GenericContainer<?> redis = new GenericContainer<>("redis:7")
        .withExposedPorts(6379)
        .withCommand("redis-server", "--requirepass", REDIS_PASSWORD);

@DynamicPropertySource
static void redisProps(DynamicPropertyRegistry r) {
    r.add("spring.data.redis.host", () -> redis.getHost());
    r.add("spring.data.redis.port", () -> redis.getMappedPort(6379));
    r.add("spring.data.redis.password", () -> REDIS_PASSWORD);
}

@Autowired
MemberService memberService;

@MockitoBean
MemberRepository memberRepository; // DB ëŒ€ì‹  ëª©

@Autowired
RedisTemplate<String, Object> redisTemplate; // ë‚´ê°€ ì •ì˜í•œ ì»¤ìŠ¤í…€ í…œí”Œë¦¿ ì´ìš©

@BeforeEach
void flush() {
    redisTemplate.getConnectionFactory().getConnection().serverCommands().flushDb();
}
```

ì´ ë¶€ë¶„ì´ ë°”ë¡œ redis passwordë¥¼ ì£¼ì…í•˜ê³  docker containerë¥¼ test í™˜ê²½ì—ì„œ ë„ìš¸ ìˆ˜ ìˆë„ë¡ í•˜ëŠ” ë¶€ë¶„ì´ë‹¤. ë˜í•œ,  ìˆœìˆ˜í•œ í™˜ê²½ì˜ testë¥¼ ìœ„í•´ REDIS ì €ì¥ì†Œë¥¼ í•œ ë²ˆ ë¹„ì›Œì£¼ëŠ” ì—­í• ì„ í•˜ê¸°ë„ í•œë‹¤.

í•˜ë‚˜ì”© ëœ¯ì–´ë³´ì.

```java
private static final String REDIS_PASSWORD = System.getenv().get("REDIS_PASSWORD");

@Container
static GenericContainer<?> redis = new GenericContainer<>("redis:7")
        .withExposedPorts(6379)
        .withCommand("redis-server", "--requirepass", REDIS_PASSWORD);
```
ë‚˜ì˜ ê²½ìš°ëŠ”, .env ì•ˆì— ëª¨ë“  ì„¤ì • íŒŒì¼ì˜ ë³€ìˆ˜ë¥¼ ë¹¼ë‘ì—ˆëŠ”ë°, ì´ë¥¼ ê°€ì ¸ì™€ì„œ ì“°ê¸° ìœ„í•¨ì´ë‹¤. System.getenv()ë¥¼ í†µí•´ envë¥¼ ê°€ì ¸ì™€ì„œ ê·¸ ì•ˆì— ìˆëŠ” REDIS_PASSWORDë¥¼ ì‚¬ìš©í•œë‹¤.

GenericContainer<>("redis:7")ì€ redis:7 ì´ë¯¸ì§€ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì»¨í…Œì´ë„ˆë¥¼ ìƒì„±í•˜ëŠ” ê²ƒì´ë‹¤. .withExposedPorts(6379)ë¥¼ í†µí•´ì„œ ì»¨í…Œì´ë„ˆì˜ 6379 í¬íŠ¸ë¥¼ í˜¸ìŠ¤íŠ¸ì˜ **ëœë¤ ê°€ìš© í¬íŠ¸**ë¡œ ë§¤í•‘í•˜ëŠ”ë°, ìš°ë¦¬ê°€ dockerë¡œ redis ì´ë¯¸ì§€ë¥¼ ë„ìš¸ë•Œ 6379 í¬íŠ¸ë¥¼ ì‚¬ìš©í–ˆìœ¼ë¯€ë¡œ ë§ì¶°ì¤€ë‹¤.

.withCommand("redis-server", "--requirepass", REDIS_PASSWORD)ë¥¼ ì´ìš©í•´ì„œ ê¸°ë³¸ ì—”íŠ¸ë¦¬í¬ì¸íŠ¸ë¥¼ ë®ì–´ì¨ì„œ **ë¹„ë²ˆì´ ê±¸ë¦° Redis**ë¡œ ì‹¤í–‰í•  ìˆ˜ ìˆê²Œ ëœë‹¤. ì—¬ê¸°ì„œ ì‚¬ìš©í•˜ëŠ” íŒ¨ìŠ¤ì›Œë“œëŠ” í™˜ê²½ë³€ìˆ˜ë¡œ ë¹ ì ¸ ìˆëŠ” REDIS_PASSWORDì´ê³ , "redis-server", "--requirepass" ì´ ëª…ë ¹ì–´ëŠ” redisë¥¼ ë¹„ë°€ë²ˆí˜¸ë¡œ ì‹¤í–‰í•˜ëŠ” ë°©ë²•ì—ëŠ”, cmdë¡œ ì…ë ¥í•˜ëŠ” ë°©ë²•ê³¼ ë‚˜ì˜ ì‹¤ìŠµ ì²˜ëŸ¼ .confë¡œ ì…ë ¥í•˜ëŠ” ë°©ë²•ì´ ìˆëŠ”ë° ê·¸ ì¤‘ clië¡œ ì…ë ¥í•˜ëŠ” ë°©ë²•ì„ ì‚¬ìš©í•œ ê²ƒì´ë‹¤.

```PowerShell
redis-server --requirepass mypassword
```

ì‹¤ì œë¡œ ì´ëŸ° ëŠë‚Œìœ¼ë¡œ ì‹¤í–‰ëœë‹¤. 

```java
@DynamicPropertySource
static void redisProps(DynamicPropertyRegistry r) {
    r.add("spring.data.redis.host", () -> redis.getHost());
    r.add("spring.data.redis.port", () -> redis.getMappedPort(6379));
    r.add("spring.data.redis.password", () -> REDIS_PASSWORD);
}
```

@DynamicPropertySourceë¥¼ í†µí•´ í…ŒìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆì—ì„œ ì–»ì€ ë™ì  ê°’ (í¬íŠ¸, í˜¸ìŠ¤íŠ¸ ë“±)ì„ Spring Boot ì„¤ì •(application.yml)ì— ë“±ë¡í•´ì¤€ë‹¤. ì¦‰, ì»¨í…Œì´ë„ˆë¥¼ ë„ìš°ëŠ” ì½”ë“œë¥¼ ì‘ì„±í–ˆìœ¼ë‹ˆ, ì´ë¥¼ í†µí•´ ì„¤ì • íŒŒì¼ì— ë“±ë¡í•œë‹¤.

hostë¥¼ í†µí•´ hostì™€ ì—°ê²°í•˜ê³ , portë¥¼ í†µí•´ ëœë¤ ê°€ìš© í¬íŠ¸ë¥¼ ë¶€íŠ¸ë¡œ ì—°ê²°í•œë‹¤.(ì»¨í…Œì´ë„ˆ ë‚´ë¶€ í¬íŠ¸ê°€ 6379ì¸ ê²ƒì´ê³ , í˜¸ìŠ¤íŠ¸ëŠ” ëœë¤ ê°€ìš© í¬íŠ¸ë¡œ ì—°ê²°ëœë‹¤.) ì´ë ‡ê²Œ í•˜ë©´ RedisTemplateê°€ ì œëŒ€ë¡œ ì—°ê²°ë  ìˆ˜ ìˆë‹¤.

ê·¸ë¦¬ê³  ë§ˆì§€ë§‰ìœ¼ë¡œëŠ” passwordë¥¼ í†µí•´ REDIS_PASSWORDë¥¼ ì£¼ì…ë°›ëŠ”ë‹¤. ì´ë ‡ê²Œ í•´ì„œ ì»¨í…Œì´ë„ˆì— ìˆëŠ” ì •ë³´ë¥¼ ìŠ¤í”„ë§ ë¶€íŠ¸ì— ì—°ê²°í•´ì¤€ë‹¤.

```java
@Autowired
MemberService memberService;

@MockitoBean
MemberRepository memberRepository; // DB ëŒ€ì‹  ëª©

@Autowired
RedisTemplate<String, Object> redisTemplate; // ë‚´ê°€ ì •ì˜í•œ ì»¤ìŠ¤í…€ í…œí”Œë¦¿ ì´ìš©

@BeforeEach
void flush() {
    redisTemplate.getConnectionFactory().getConnection().serverCommands().flushDb();
}
```

@MockitoBeanë¥¼ í†µí•´ì„œ `MemberRepository`ì˜ **Mockito ëª© ê°ì²´**ë¥¼ ë“±ë¡í•œë‹¤. ì‹¤ì œ JPA ë¦¬í¬ì§€í† ë¦¬ ë¹ˆì„ ëŒ€ì‹ /ëŒ€ì²´í•´ì„œ ì£¼ì…ë˜ë¯€ë¡œ DBë¥¼ ì „í˜€ íƒ€ì§€ ì•ŠëŠ”ë‹¤ëŠ” íŠ¹ì§•ì´ ìˆë‹¤.

RedisTemplate<String, Object> redisTemplateì„ í†µí•´ ë‚´ê°€ ì •ì˜í•œ ì»¤ìŠ¤í…€ í…œí”Œë¦¿ì„ ê°€ì ¸ì™€ì„œ ì‚¬ìš©í•˜ë„ë¡ í•œë‹¤.

## Test code 1_ë ˆë””ìŠ¤ ìºì‹± í…ŒìŠ¤íŠ¸

```java
@Test
void redis_actually_stores_cache() {
    Long id = 1L;
    Mockito.when(memberRepository.findBalanceByMemberId(id)).thenReturn(7000);

    // Redisê°€ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸
    Set<String> keysBefore = redisTemplate.keys("*");
    log.info("Redis keys before: {}", keysBefore);

    // ì²« ë²ˆì§¸ í˜¸ì¶œ - ìºì‹œ ì €ì¥ë¨
    int balance = memberService.getBalance(id);
    assertThat(balance).isEqualTo(7000);

    // Redisì— í‚¤ê°€ ìƒê²¼ëŠ”ì§€ í™•ì¸
    Set<String> keysAfter = redisTemplate.keys("*");
    log.info("Redis keys after: {}", keysAfter);

    // ì €ì¥ëœ ê°’ë“¤ ì¶œë ¥í•´ë³´ê¸°
    for (String key : keysAfter) {
        Object value = redisTemplate.opsForValue().get(key);
        Long ttl = redisTemplate.getExpire(key);
        log.info("Key : {}, Value : {}, TTL : {} seconds",key,value,ttl);
    }

    // RepositoryëŠ” 1ë²ˆë§Œ í˜¸ì¶œë¨ (ì™œëƒë©´.. ìºì‹±ì´ ë˜ì—ˆê¸° ë•Œë¬¸ì´ë‹¤.)
    Mockito.verify(memberRepository, Mockito.times(1)).findBalanceByMemberId(id);
}
```

ìš°ì„ , redisTemplate.keys("*");ì„ í†µí•´ í˜„ì¬ ì—°ê²°ëœ redisì— í‚¤ê°€ ì¡´ì¬í•˜ëŠ”ì§€ë¥¼ í™•ì¸í•œë‹¤. ì•„ì§ ìºì‹±í•˜ì§€ ì•Šì•˜ìœ¼ë¯€ë¡œ í‚¤ëŠ” ì¡´ì¬í•˜ì§€ ì•Šì„ ê²ƒì´ë‹¤.

memberService.getBalance(id)ë¥¼ í†µí•´ ë„£ìœ¼ë©´, ë‚´ë¶€ ë¡œì§ì—ì„œ ìºì‹±ì´ ë˜ì–´ ìˆì§€ ì•Šì„ ê²½ìš° dbì—ì„œ ê°’ì„ ì°¾ì•„ì„œ ì €ì¥í•˜ëŠ” ë¶€ë¶„ì´ êµ¬í˜„ë˜ì–´ ìˆìœ¼ë¯€ë¡œ cacheì— ì €ì¥í•œ í›„ ê°’ì„ ê°€ì ¸ì˜¬ ìˆ˜ ìˆë‹¤.

redisTemplateì—ì„œëŠ” redisTemplate.opsForValue().get(key); ì´ê±¸ í†µí•´ valueê°’ì„ Object íƒ€ì…ìœ¼ë¡œ ê°€ì ¸ì˜¬ ìˆ˜ ìˆë‹¤. (getì„ í†µí•´ keyë¥¼ ì‚¬ìš©í•´ì„œ) ì´ë ‡ê²Œ ê°€ì ¸ì˜¨ ê°’ì„ êº¼ë‚´ë³´ë©´, ìš°ë¦¬ê°€ ë„£ì–´ì¤€ ê°’ì¸ 7000ì´ë¼ëŠ” balance ê°’ì´ ì˜ ë“¤ì–´ê°€ ìˆëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.
memberRepositoryëŠ”, ì´ˆë°˜ì— ìºì‹œê°€ ì—†ì„ ë•Œ í•œ ë²ˆë§Œ í˜¸ì¶œë˜ë¯€ë¡œ, ì´ í˜¸ì¶œíšŸìˆ˜ëŠ” í•œ ë²ˆì´ ë˜ì–´ testë¥¼ í†µê³¼í•  ìˆ˜ ìˆë‹¤.

```java
2025-09-05T19:55:51.692+09:00  INFO 1920 --- [    Test worker] s.r.service.MemberServiceCacheTest       : Redis keys before: []
2025-09-05T19:55:51.704+09:00  INFO 1920 --- [    Test worker] s.r.service.MemberServiceCacheTest       : Redis keys after: [v1:bal:user:1]
2025-09-05T19:55:51.712+09:00  INFO 1920 --- [    Test worker] s.r.service.MemberServiceCacheTest       : Key : v1:bal:user:1, Value : 7000, TTL : 180 seconds
```

## Test code 2_ë ˆë””ìŠ¤ ìºì‹± í…ŒìŠ¤íŠ¸ - ê°ê¸° ë‹¤ë¥¸ í˜•íƒœì˜ ê°ì²´ê°€ ì˜ ì €ì¥ ë˜ëŠ”ì§€ì— ê´€í•˜ì—¬

```java
@Test
void redisStoresDifferentCacheTypes() {
    //testì— ì‚¬ìš©í•˜ê¸° ìœ„í•œ ê°ì²´ë“¤
    Long id = 1L;
    MemberCachingDto dto = MemberCachingDto.builder()
            .name("í”¼ìš©í¬")
            .creditLimit(100000)
            .build();
    int balance = 5000;
    String hobby = "ì¶•êµ¬";

    // Repository Mock ì„¤ì •
    Mockito.when(memberRepository.findBalanceByMemberId(id)).thenReturn(balance);
    Mockito.when(memberRepository.findHobbyByMemberId(id)).thenReturn(hobby);
    Mockito.when(memberRepository.findDtoByMemberId(id)).thenReturn(dto);

    System.out.println("=== ìºì‹œ ì €ì¥ ì „ ===");
    Set<String> keysBefore = redisTemplate.keys("*");
    log.info("Redis keys: {}",keysBefore);

    // ì—¬ëŸ¬ ì¢…ë¥˜ ìºì‹œ ì €ì¥
    balance = memberService.getBalance(id);
    hobby = memberService.getHobby(id);
    dto = memberService.getSnapshot(id);

    System.out.println("=== ìºì‹œ ì €ì¥ í›„ ===");
    log.info("Balance: {}, Hobby: {}, dto : {}",balance,hobby,dto);

    Set<String> keysAfter = redisTemplate.keys("*");
    log.info("Redis keys: {}",keysAfter);

    // ëª¨ë“  ì €ì¥ëœ ë°ì´í„° ì¶œë ¥
    for (String key : keysAfter) {
        Object value = redisTemplate.opsForValue().get(key);
        Long ttl = redisTemplate.getExpire(key);
        log.info("Key: {}",key);
        log.info("Value: {}",value);
        log.info("TTL: {} seconds",ttl);
        log.info("Type: {}",redisTemplate.type(key)); //int, String, dto ë‚˜ì™€ì•¼ í•œë‹¤.
    }
    assertThat(keysAfter.size()).isGreaterThanOrEqualTo(3); // balance, hobby, dto ìµœì†Œ 3ê°œ
}
```

ìš°ë¦¬ì˜ ê²½ìš°ëŠ” cacheì— ë„£ëŠ” ê°’ë“¤ì„ ë‹¤ ë‹¤ë¥¸ íƒ€ì…ìœ¼ë¡œ ì •ì˜í–ˆê¸° ë•Œë¬¸ì— ê°ê°ì´ ì˜ ì €ì¥ë˜ì—ˆëŠ”ì§€ ì‚´í´ë´ì•¼ í•œë‹¤.

balance = memberService.getBalance(id);
hobby = memberService.getHobby(id);
dto = memberService.getSnapshot(id);

í•´ë‹¹ get ê°’ë“¤ì€ ìš°ì„  ìºì‹œì— ì—†ìœ¼ë©´ dbì—ì„œ ìºì‹œì— ì €ì¥í•œë‹¤ìŒ return í•˜ë„ë¡ ì„¤ì •í–ˆê¸° ë•Œë¬¸ì—, ìš°ë¦¬ê°€ ì›í•˜ëŠ” value ê°’ë“¤ì´ ë‚˜ì˜¬ ê²ƒì´ë‹¤.

forë¬¸ì„ í†µí•´ redisTemplateì—ì„œ keyë¡œ ê°€ì ¸ì˜¨ value ê°’ì„ í™•ì¸í•´ì„œ, ê°ê°ì˜ valueë“¤ì´ ì˜ ë‚˜ì˜¤ëŠ”ì§€ë¥¼ ì‚´í´ë³´ì.

ê²°ê³¼ë¥¼ ë³´ë©´, ìš°ë¦¬ê°€ ì›í–ˆë˜ ëŒ€ë¡œ ê°ê°ì´ ë‹¤ë¥¸ value í˜•íƒœë¡œ ì˜ ë‚˜ì˜¤ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤. (ë§ˆì§€ë§‰ì€ dto íƒ€ì…ìœ¼ë¡œ ë°”ë¡œ ë‚˜ì˜¤ë„ë¡ êµ¬ì„±í–ˆë‹¤.)

```java
=== ìºì‹œ ì €ì¥ ì „ ===
2025-09-05T19:55:51.049+09:00  INFO 1920 --- [    Test worker] s.r.service.MemberServiceCacheTest       : Redis keys: []
=== ìºì‹œ ì €ì¥ í›„ ===
2025-09-05T19:55:51.359+09:00  INFO 1920 --- [    Test worker] s.r.service.MemberServiceCacheTest       : Balance: 5000, Hobby: ì¶•êµ¬, dto : MemberCachingDto(name=í”¼ìš©í¬, creditLimit=100000)
```

## Test code 3_ë ˆë””ìŠ¤ ìºì‹± í…ŒìŠ¤íŠ¸ - ìºì‹œíˆíŠ¸ í…ŒìŠ¤íŠ¸

```java
 @Test
void redisCacheHitVerification() {
    Long id = 1L;
    Mockito.when(memberRepository.findBalanceByMemberId(id)).thenReturn(9999);

    System.out.println("=== ì²« ë²ˆì§¸ í˜¸ì¶œ (ìºì‹œ ë¯¸ìŠ¤) ===");
    int result1 = memberService.getBalance(id);
    Set<String> keys1 = redisTemplate.keys("*");
    log.info("Result: {}",result1);
    log.info("Redis keys: {}", keys1);

    // Repository Mockì„ ë‹¤ë¥¸ ê°’ìœ¼ë¡œ ë³€ê²½ (ìºì‹œ íˆíŠ¸ë©´ ì´ ê°’ì´ ì•ˆë‚˜ì™€ì•¼ í•¨...ë°”ë€Œê¸° ì „ ê°’ì´ ì™€ì•¼ í•˜ë‹ˆê¹Œ)
    Mockito.when(memberRepository.findBalanceByMemberId(id)).thenReturn(1111);

    System.out.println("=== ë‘ ë²ˆì§¸ í˜¸ì¶œ (ìºì‹œ íˆíŠ¸) ===");
    int result2 = memberService.getBalance(id);
    Set<String> keys2 = redisTemplate.keys("*");
    log.info("Result: {}",result2);
    log.info("Redis keys: {}", keys2);

    // ìºì‹œì—ì„œ ê°€ì ¸ì˜¨ ê°’ì´ë¯€ë¡œ ì²« ë²ˆì§¸ì™€ ê°™ì•„ì•¼ í•¨ (9999)
    assertThat(result2).isEqualTo(9999);
    assertThat(result2).isNotEqualTo(1111); // Mockì˜ ìƒˆ ê°’ì´ ì•„ë‹˜

    // RepositoryëŠ” 1ë²ˆë§Œ í˜¸ì¶œë¨ (ìºì‹œ íˆíŠ¸)
    Mockito.verify(memberRepository, Mockito.times(1)).findBalanceByMemberId(id);

    log.info("ìºì‹œ íˆíŠ¸ ì„±ê³µ! RepositoryëŠ” {}ì´ê³ , {}ë²ˆë§Œ í˜¸ì¶œ",result2,Mockito.mockingDetails(memberRepository).getInvocations().size());
}
```

ì²«ë²ˆì§¸ í˜¸ì¶œì˜ ê²½ìš°ëŠ”, mockì— ì €ì¥ëœ í›„ ìºì‹±ëœ ê°’ì´ ì•„ì§ ì—†ê¸° ë•Œë¬¸ì— ìºì‹œ ë¯¸ìŠ¤ê°€ ë°œìƒí•  ê²ƒì´ë‹¤.

ìºì‹œ ë¯¸ìŠ¤ê°€ ë°œìƒí•  ê²½ìš°, dbì—ì„œ ê°€ì ¸ì˜¨ ì •ë³´ì¸ 9999ë¥¼ ì €ì¥í•˜ê²Œ ë˜ì–´ 9999ë¼ëŠ” ê°’ì´ ì €ì¥ëœë‹¤

ìºì‹œ íˆíŠ¸ í…ŒìŠ¤íŠ¸ëŠ”, ìºì‹œì— ê°’ì´ ì´ë¯¸ ìˆì–´ì„œ dbì—ì„œ ê°’ì„ ë°”ê¿”ë„ ìºì‹œì— ê°’ì´ ë‚¨ì•„ìˆëŠ” ê²ƒì„ í™•ì¸í•˜ê¸° ìœ„í•¨ì´ë‹¤.

Mockito.when(memberRepository.findBalanceByMemberId(id)).thenReturn(1111);ë¥¼ í†µí•´ mockì˜ ê°’ì„ 1111ë¡œ ë°”ê¿¨ì§€ë§Œ, ì•„ì§ ìºì‹œ ì•ˆì˜ TTLì´ ë§Œë£Œë˜ì§€ ì•Šì•˜ê¸° ë•Œë¬¸ì— assertThat(result2).isEqualTo(9999);ê°€ trueë¡œ ë‚˜ì˜¤ê³ , assertThat(result2).isNotEqualTo(1111);ê°€ trueë¡œ ë‚˜ì˜¨ë‹¤.

ì‹¤ì œë¡œ Mockito.mockingDetails(memberRepository).getInvocations().size()ë¥¼ ì°ì–´ë³´ë©´, ì²˜ìŒ ìºì‹œ ë¯¸ìŠ¤ì¼ë•Œ ë”± í•œë²ˆë§Œ í˜¸ì¶œëœ ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.

```java
=== ì²« ë²ˆì§¸ í˜¸ì¶œ (ìºì‹œ ë¯¸ìŠ¤) ===
2025-09-05T19:55:51.644+09:00  INFO 1920 --- [    Test worker] s.r.service.MemberServiceCacheTest       : Result: 9999
2025-09-05T19:55:51.645+09:00  INFO 1920 --- [    Test worker] s.r.service.MemberServiceCacheTest       : Redis keys: [v1:bal:user:1]
=== ë‘ ë²ˆì§¸ í˜¸ì¶œ (ìºì‹œ íˆíŠ¸) ===
2025-09-05T19:55:51.654+09:00  INFO 1920 --- [    Test worker] s.r.service.MemberServiceCacheTest       : Result: 9999
2025-09-05T19:55:51.654+09:00  INFO 1920 --- [    Test worker] s.r.service.MemberServiceCacheTest       : Redis keys: [v1:bal:user:1]
2025-09-05T19:55:51.669+09:00  INFO 1920 --- [    Test worker] s.r.service.MemberServiceCacheTest       : ìºì‹œ íˆíŠ¸ ì„±ê³µ! RepositoryëŠ” 9999ì´ê³ , 1ë²ˆë§Œ í˜¸ì¶œ
```

## ì „ì²´ test ê²°ê³¼

![image.png](/images/2025-09-06-redis-3/2.png)

í…ŒìŠ¤íŠ¸ë„ ì´ì˜ê²Œ í†µê³¼ëœ ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤:)

